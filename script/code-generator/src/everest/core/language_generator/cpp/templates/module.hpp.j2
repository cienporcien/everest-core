{% from "helper_macros.j2" import print_spdx_line, print_template_info, include_batches, insert_block, cpp_type  %}
{{ print_spdx_line('Apache-2.0') }}
#ifndef {{ hpp_guard }}
#define {{ hpp_guard }}

{{ print_template_info('3', 'marked regions will be kept') }}

{{ include_batches(includes) }}

{{ insert_block(blocks.add_headers) }}

namespace module {

struct Conf {
    {% for item in config %}
    {{ cpp_type(item.type) }} {{ item.name }};
    {% endfor %}
};

class {{ class_name }} : public Everest::ModuleBase {
public:
    {{ class_name }}() = delete;
    {{ class_name }}(
        const ModuleInfo& info,
        {% if module.info.enable_external_mqtt %}
        Everest::MqttProvider& mqtt_provider,
        {% endif %}
        {% if module.info.enable_telemetry %}
        Everest::TelemetryProvider& telemetry,
        {% endif %}
        {% for impl in module.provides %}
        std::unique_ptr<{{ impl.base_class }}> p_{{ impl.id }},
        {% endfor %}
        {% for requirement in module.requires %}
        {% if requirement.is_vector %}
        std::vector<std::unique_ptr<{{ requirement.class_name }}>> r_{{ requirement.id }},
        {% else %}
        std::unique_ptr<{{ requirement.class_name }}> r_{{ requirement.id }},
        {% endif %}
        {% endfor %}
        Conf& config
    ) :
        ModuleBase(info),
        {% if module.info.enable_external_mqtt %}
        mqtt(mqtt_provider),
        {% endif %}
        {% if module.info.enable_telemetry %}
        telemetry(telemetry),
        {% endif %}
        {% for impl in module.provides %}
        p_{{ impl.id }}(std::move(p_{{ impl.id }})),
        {% endfor %}
        {% for requirement in module.requires %}
        r_{{ requirement.id }}(std::move(r_{{ requirement.id }})),
        {% endfor %}
        config(config)
    {};

    {% if module.info.enable_external_mqtt %}
    Everest::MqttProvider& mqtt;
    {% endif %}
    {% if module.info.enable_telemetry %}
    Everest::TelemetryProvider& telemetry;
    {% endif %}
    {% for impl in module.provides %}
    const std::unique_ptr<{{ impl.base_class }}> p_{{ impl.id }};
    {% endfor %}
    {% for requirement in module.requires %}
    {% if requirement.is_vector %}
    const std::vector<std::unique_ptr<{{ requirement.class_name }}>> r_{{ requirement.id }};
    {% else %}
    const std::unique_ptr<{{ requirement.class_name }}> r_{{ requirement.id }};
    {% endif %}
    {% endfor %}
    const Conf& config;

    {{ insert_block(blocks.public_defs, indent=4) }}

protected:
    {{ insert_block(blocks.protected_defs, indent=4) }}

private:
    friend class LdEverest;
    void init();
    void ready();

    {{ insert_block(blocks.private_defs, indent=4) }}

};

{{ insert_block(blocks.after_class) }}

} // namespace module

#endif // {{ hpp_guard }}
